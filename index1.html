<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RealyMedios Radio</title>
    <style>
        /* Estilos generales */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #000; /* Fondo negro */
            color: #FFA500; /* Color ocre para el texto */
        }

        header {
            background-color: #000; /* Fondo negro */
            color: #FFA500; /* Texto ocre */
            box-shadow: 0 4px 6px rgba(255, 165, 0, 0.3); /* Sombra con tono ocre */
            padding: 10px;
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center; /* Centrar contenido verticalmente */
        }

        /* Contenedor para el logo y el título */
        .header-top {
            display: flex;
            justify-content: space-between; /* Espacio entre logo/título y menú */
            align-items: center; /* Alinear elementos verticalmente */
            width: 100%;
            max-width: 1200px; /* Ancho máximo para diseño responsivo */
            margin: 0 auto; /* Centrar el contenedor */
        }

        .header-top img {
            width: 80px; /* Tamaño del logo más grande */
            height: auto;
        }

        h1 {
            margin: 0;
            font-size: 24px; /* Tamaño reducido para la cabecera */
        }

        nav {
            display: flex;
            gap: 20px;
        }

        nav a {
            text-decoration: none;
            color: #FFA500; /* Enlaces ocre */
            font-weight: bold;
        }

        main {
            margin-top: 200px; /* Espacio para el reproductor fijo */
            padding: 20px;
            text-align: center; /* Centrar contenido principal */
        }

        footer {
            text-align: center;
            padding: 20px;
            background-color: #000; /* Fondo negro */
            color: #FFA500; /* Texto ocre */
        }

        /* Reproductor de audio centrado en la cabecera */
        .media-player {
            margin-top: 10px; /* Espacio entre el título y el reproductor */
        }

        audio {
            background-color: #111; /* Fondo oscuro para el reproductor */
            color: #FFA500; /* Controles ocre */
            width: 90%; /* Ancho del reproductor más largo */
            max-width: 600px; /* Ancho máximo para evitar que sea demasiado grande */
        }
    </style>
</head>
<body>
    <!-- Cabecera fija con reproductor -->
    <header>
        <!-- Contenedor superior con logo, título y menú -->
        <div class="header-top">
            <div style="display: flex; align-items: center;">
                <img src="logo.png" alt="Logotipo de RealyMedios Radio">
                <h1>RealyMedios Radio</h1>
            </div>
            <nav>
                <a href="#">Inicio</a>
                <a href="#">Acerca de</a>
                <a href="#">Contacto</a>
            </nav>
        </div>
        <div class="media-player">
            <!-- Reproductor de Audio -->
            <audio id="streamAudio" controls autoplay>
                <source id="audioSource" src="" type="audio/mpeg">
                Tu navegador no soporta el reproductor de audio.
            </audio>
            <div id="metadata">Cargando información...</div>
            <div id="connections">Cargando número de conexiones...</div>
        </div>
    </header>

    <main>
        <!-- Texto centrado -->
        <h2>Tu Radio Real</h2>
        <p>Transmitiendo música variada las 24 horas del día para todos los oyentes.</p>
        <p><strong>En Periodo de Prueba...</strong></p>
    </main>

    <!-- Pie de página -->
    <footer>
        <p>Instagram: @RealyMedios</p>
        <p>TikTok: @RealyMediosRadio</p>
        <p>WhatsApp: 0412.7047374</p>
        <p>© 2025 RealyMedios Radio. Todos los derechos reservados.</p>
    </footer>

    <!-- JavaScript para cargar la URL del stream y obtener metadatos -->
    <script>
        // Elementos HTML para mostrar metadatos
        const metadataDiv = document.getElementById('metadata');
        const connectionsDiv = document.getElementById('connections');

        // Reproductor de audio
        const streamAudio = document.getElementById('streamAudio');
        const audioSource = document.getElementById('audioSource');

        // Función para iniciar la reproducción del mensaje.mp3
        function playInitialMessage() {
            audioSource.src = 'mensaje.mp3'; // Asignar el archivo de mensaje
            streamAudio.load(); // Cargar el mensaje
            streamAudio.play(); // Reproducir el mensaje

            // Escuchar el evento "ended" para cambiar al stream cuando termine el mensaje
            streamAudio.addEventListener('ended', () => {
                loadStreamUrl(); // Conectar al stream después de que termine el mensaje
            });
        }

        // Cargar la URL del stream desde stream-url.txt
        async function loadStreamUrl() {
            try {
                const response = await fetch('stream-url.txt'); // Asegúrate de que este archivo exista en tu servidor
                if (!response.ok) {
                    throw new Error(`Error al cargar stream-url.txt (código ${response.status})`);
                }
                let data = await response.text();
                let trimmedUrl = data.trim(); // Elimina espacios en blanco

                // Quitar "/stream" de la URL si existe
                if (trimmedUrl.endsWith('/stream')) {
                    trimmedUrl = trimmedUrl.slice(0, -7); // Elimina los últimos 7 caracteres ("/stream")
                }
                console.log("URL base después de quitar '/stream':", trimmedUrl);

                // Asignar la URL al reproductor de audio
                audioSource.src = `${trimmedUrl}/stream`; // Vuelve a agregar "/stream" para el reproductor
                streamAudio.load(); // Carga el nuevo stream
                streamAudio.play(); // Iniciar la reproducción del stream
                console.log("URL cargada para el reproductor:", `${trimmedUrl}/stream`);

                // Obtener metadatos y conexiones usando la URL base
                fetchMetadataAndConnections(trimmedUrl);
            } catch (error) {
                console.error("Error al cargar la URL del stream:", error);
                metadataDiv.textContent = "No se pudo cargar la información.";
                connectionsDiv.textContent = "No se pudo cargar el número de conexiones.";
            }
        }

        // Función para obtener metadatos y número de conexiones
        async function fetchMetadataAndConnections(baseUrl) {
            if (!baseUrl) {
                console.error("No hay una URL base válida para obtener los metadatos.");
                return;
            }
            try {
                // Construir la URL completa para los metadatos
                const metadataUrl = `${baseUrl}/status-json.xsl`;
                console.log("Intentando cargar metadatos desde:", metadataUrl);

                // Hacer la solicitud directamente sin proxy
                const response = await fetch(metadataUrl);
                if (!response.ok) {
                    throw new Error(`Error al cargar los metadatos (código ${response.status})`);
                }
                const data = await response.json();

                // Mostrar metadatos
                const currentSong = data.icestats.source.title || "Información no disponible";
                metadataDiv.textContent = `Ahora sonando: ${currentSong}`;

                // Mostrar número de conexiones
                const listenerCount = data.icestats.source.listeners || 0;
                connectionsDiv.textContent = `Oyentes conectados: ${listenerCount}`;
            } catch (error) {
                console.error("Error al obtener metadatos y conexiones:", error);
                metadataDiv.textContent = "No se pudo cargar la información.";
                connectionsDiv.textContent = "No se pudo cargar el número de conexiones.";

                // Intentar otro endpoint común si el primero falla
                try {
                    const fallbackUrl = `${baseUrl}/stats`;
                    console.log("Intentando cargar metadatos desde fallback:", fallbackUrl);
                    const fallbackResponse = await fetch(fallbackUrl);
                    if (!fallbackResponse.ok) {
                        throw new Error(`Error al cargar los metadatos del fallback (código ${fallbackResponse.status})`);
                    }
                    const fallbackData = await fallbackResponse.json();

                    // Mostrar metadatos del fallback
                    const fallbackSong = fallbackData.current_song || "Información no disponible";
                    metadataDiv.textContent = `Ahora sonando: ${fallbackSong}`;

                    // Mostrar número de conexiones del fallback
                    const fallbackListeners = fallbackData.listeners || 0;
                    connectionsDiv.textContent = `Oyentes conectados: ${fallbackListeners}`;
                } catch (fallbackError) {
                    console.error("Error al obtener metadatos del fallback:", fallbackError);
                    metadataDiv.textContent = "No se pudo cargar la información.";
                    connectionsDiv.textContent = "No se pudo cargar el número de conexiones.";
                }
            }
        }

        // Actualizar metadatos cada 30 segundos
        setInterval(() => {
            fetchMetadataAndConnections(audioSource.src.split('/').slice(0, -1).join('/')); // Usar la URL base del stream
        }, 30000);

        // Inicializar la reproducción del mensaje y la carga del stream
        playInitialMessage();
    </script>
</body>
</html>
